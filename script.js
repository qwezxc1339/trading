let cooldowns={};let currentPair="";document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("generate-btn"),t=document.getElementById("signal-result"),n=document.getElementById("signal-time"),a=document.getElementById("currency-pair");let i=null;currentPair=a.value;const o=document.getElementById("chart");new IntersectionObserver(e=>{e[0].isIntersecting&&initChart()},{threshold:.1}).observe(o),e.addEventListener("click",()=>{e.disabled=!0,e.classList.add("loading"),e.textContent=translations[document.getElementById("language").value].waiting,console.log("Button clicked, generating signal..."),i&&clearTimeout(i),i=setTimeout(()=>{try{const i=a.value,o=document.getElementById("timeframe").value,l=parseTimeframeToMs(o),r=Math.random()>.5,s=(10*Math.random()+85).toFixed(2),d=(new Date).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit",second:"2-digit"}),c=document.getElementById("language").value,u=r?translations[c].buy:translations[c].sell,m=r?"↑":"↓",g=`<div class="signal-details"><div class="signal-pair">${i}</div><div class="signal-direction ${r?"green":"red"}"><span class="direction-icon">${m}</span> ${u}</div><div class="signal-timeframe">${translations[c].timeframe}: ${o}</div><div class="signal-probability">${translations[c].accuracy}: ${s}%</div></div>`;t.innerHTML=g,n.textContent=d,t.style.opacity=0,t.style.transform="translateY(20px)",setTimeout(()=>{t.style.opacity=1,t.style.transform="translateY(0)"},100);const p=Date.now()+l;cooldowns[i]?.intervalId&&clearInterval(cooldowns[i].intervalId),cooldowns[i]={endTime:p},startCooldown(i),updateChart(i,r,s),e.classList.remove("loading")}catch(n){console.error(n),t.innerHTML='<div class="signal-error">Ошибка генерации сигнала. Попробуйте снова.</div>',e.disabled=!1,e.textContent=translations[document.getElementById("language").value].generateButton,e.classList.remove("loading")}},1e3)}),a.addEventListener("change",()=>{const t=a.value;cooldowns[currentPair]?.intervalId&&clearInterval(cooldowns[currentPair].intervalId),currentPair=t,cooldowns[t]&&cooldowns[t].endTime>Date.now()?startCooldown(t):(e.disabled=!1,e.textContent=translations[document.getElementById("language").value].generateButton)});const l=localStorage.getItem("theme")||"dark";document.body.classList.add(l+"-theme"),document.getElementById("theme-select").value=l});function startCooldown(e){const t=document.getElementById("generate-btn"),n=document.createElement("div");n.classList.add("progress-bar"),t.appendChild(n);function a(){const a=Date.now(),i=Math.ceil((cooldowns[e].endTime-a)/1e3),o=document.getElementById("language").value,l=translations[o].generateButton;if(i<=0)clearInterval(cooldowns[e].intervalId),t.disabled=!1,t.textContent=l,n.style.width="0%",delete cooldowns[e],n.remove();else{t.disabled=!0,t.textContent=`${l} (${i}s)`;const e=((cooldowns[e].endTime-a)/(cooldowns[e].endTime-(cooldowns[e].endTime-i*1e3)))*100;n.style.width=`${e}%`}}a(),cooldowns[e].intervalId=setInterval(a,1e3)}function parseTimeframeToMs(e){const t=e.toLowerCase(),n=t.match(/\d+/),a=n?parseInt(n[0],10):30;return t.includes("second")||t.includes("seconds")||t.includes("секунд")||t.includes("секунда")||t.includes("soniya")?1e3*a:t.includes("minute")||t.includes("minutes")||t.includes("min")||t.includes("минут")||t.includes("минута")||t.includes("минуты")||t.includes("daqiqa")?6e4*a:3e4}function resetSignalAndChart(){const e=document.getElementById("signal-result"),t=document.getElementById("signal-time");e.innerHTML=`<div class="signal-placeholder">${translations[document.getElementById("language").value].signalPlaceholder}</div>`,t.textContent="",initChart()}function initChart(){const e=d3.select("#chart");e.selectAll("*").remove();const t=e.node().getBoundingClientRect().width,n=400,a={top:20,right:30,bottom:40,left:50},i=e.append("svg").attr("width",t).attr("height",n).attr("viewBox",`0 0 ${t} ${n}`).attr("preserveAspectRatio","xMidYMid meet");i.append("text").attr("x",t/2).attr("y",n/2).attr("text-anchor","middle").attr("fill","#A0A0A0").text("График появится после получения сигнала")}function updateChart(e,t,n){const a=d3.select("#chart");a.selectAll("*").remove();const i=a.node().getBoundingClientRect().width,o=400,l={top:20,right:30,bottom:40,left:50},r=Array.from({length:30},(e,n)=>({time:n,value:100+(Math.random()-.5)*10*n*(t?1:-1)})),s=d3.scaleLinear().domain([0,r.length-1]).range([l.left,i-l.right]),d=d3.scaleLinear().domain([d3.min(r,e=>e.value)-10,d3.max(r,e=>e.value)+10]).range([o-l.bottom,l.top]),c=d3.line().x(e=>s(e.time)).y(e=>d(e.value)).curve(d3.curveCatmullRom.alpha(.5)),u=d3.area().x(e=>s(e.time)).y0(o-l.bottom).y1(e=>d(e.value)).curve(d3.curveCatmullRom.alpha(.5));const m=a.append("svg").attr("width",i).attr("height",o).attr("viewBox",`0 0 ${i} ${o}`).attr("preserveAspectRatio","xMidYMid meet"),g=m.append("defs").append("linearGradient").attr("id","area-gradient").attr("gradientUnits","userSpaceOnUse").attr("x1",0).attr("y1",d(d3.min(r,e=>e.value))).attr("x2",0).attr("y2",d(d3.max(r,e=>e.value)));g.append("stop").attr("offset","0%").attr("stop-color",t?"rgba(0, 230, 118, 0.2)":"rgba(255, 82, 82, 0.2)"),g.append("stop").attr("offset","100%").attr("stop-color","rgba(0, 0, 0, 0)"),m.append("path").datum(r).attr("fill","url(#area-gradient)").attr("d",u).attr("opacity",0).transition().duration(1e3).attr("opacity",1);const p=m.append("path").datum(r).attr("fill","none").attr("stroke",t?"#00E676":"#FF5252").attr("stroke-width",2.5).attr("d",c),h=p.node().getTotalLength();p.attr("stroke-dasharray",h+" "+h).attr("stroke-dashoffset",h).transition().duration(1500).ease(d3.easeLinear).attr("stroke-dashoffset",0);const f=d3.select("body").append("div").attr("class","tooltip").style("opacity",0).style("position","absolute").style("background","var(--bg-light)").style("border","1px solid var(--border-color)").style("padding","8px").style("border-radius","4px").style("pointer-events","none");m.selectAll("dot").data(r).enter().append("circle").attr("r",4).attr("cx",e=>s(e.time)).attr("cy",e=>d(e.value)).attr("fill",t?"#00E676":"#FF5252").attr("opacity",.7).on("mouseover",function(e,n){d3.select(this).attr("r",6).attr("opacity",1),f.transition().duration(200).style("opacity",.9),f.html(`Time: ${n.time}<br>Value: ${n.value.toFixed(2)}`).style("left",e.pageX+10+"px").style("top",e.pageY-20+"px")}).on("mouseout",function(){d3.select(this).attr("r",4).attr("opacity",.7),f.transition().duration(500).style("opacity",0)});const b=d3.zoom().scaleExtent([1,5]).translateExtent([[0,0],[i,o]]).on("zoom",e=>{const t=e.transform.rescaleX(s),n=e.transform.rescaleY(d);m.selectAll("path.line").attr("d",c.x(e=>t(e.time))),m.selectAll("path.area").attr("d",u.x(e=>t(e.time)).y1(e=>n(e.value))),m.selectAll("circle").attr("cx",e=>t(e.time)).attr("cy",e=>n(e.value)),m.select(".x-axis").call(d3.axisBottom(t)),m.select(".y-axis").call(d3.axisLeft(n))});m.call(b),m.append("g").attr("class","x-axis").attr("transform",`translate(0,${o-l.bottom})`).call(d3.axisBottom(s).ticks(5).tickSizeOuter(0)).attr("color","#555"),m.append("g").attr("class","y-axis").attr("transform",`translate(${l.left},0)`).call(d3.axisLeft(d).ticks(5).tickSizeOuter(0)).attr("color","#555")}const translations={ru:{logoText:"Торговый сигнал",currencyLabel:"Актив",timeframeLabel:"Время",generateButton:"Получить сигнал",waiting:"Ожидание...",signalTitle:"Сигнал",signalPlaceholder:"Нажмите 'Получить сигнал'",languageLabel:"Язык",timeframes:["5 секунд","15 секунд","1 минута","3 минуты","5 минут","10 минут"],buy:"Купить",sell:"Продать",timeframe:"Временной интервал",accuracy:"Точность"},en:{logoText:"Trade Signal",currencyLabel:"Instrument",timeframeLabel:"Time",generateButton:"Get Signal",waiting:"Waiting...",signalTitle:"Signal",signalPlaceholder:"Click 'Get Signal'",languageLabel:"Language",timeframes:["5 seconds","15 seconds","1 minute","3 minutes","5 minutes","10 minutes"],buy:"Buy",sell:"Sell",timeframe:"Timeframe",accuracy:"Accuracy"},uz:{logoText:"Savdo Signali",currencyLabel:"Asbob",timeframeLabel:"Vaqt",generateButton:"Signal Olish",waiting:"Kutmoqda...",signalTitle:"Signal",signalPlaceholder:"Signal Olish uchun bosing",languageLabel:"Til",timeframes:["5 soniya","15 soniya","1 daqiqa","3 daqiqa","5 daqiqa","10 daqiqa"],buy:"Sotib olish",sell:"Sotish",timeframe:"Vaqt oralig'i",accuracy:"Aniqlik"}};function changeLanguage(){const e=document.getElementById("language").value;document.getElementById("logo-text").textContent=translations[e].logoText,document.getElementById("currency-label").textContent=translations[e].currencyLabel,document.getElementById("timeframe-label").textContent=translations[e].timeframeLabel,document.getElementById("generate-btn").textContent=translations[e].generateButton,document.getElementById("signal-title").textContent=translations[e].signalTitle;const t=document.getElementById("signal-result").querySelector(".signal-placeholder");t&&(t.textContent=translations[e].signalPlaceholder);const n=document.querySelector(".language-selector label");n&&(n.textContent=translations[e].languageLabel);const a=document.getElementById("timeframe");a.innerHTML="",translations[e].timeframes.forEach(e=>{const t=document.createElement("option");t.textContent=e,a.appendChild(t)}),resetSignalAndChart()}function toggleTheme(){const e=document.getElementById("theme-select").value;document.body.classList.remove("dark-theme","light-theme"),document.body.classList.add(e+"-theme"),localStorage.setItem("theme",e),document.body.style.transition="background-color 0.5s ease, color 0.5s ease",setTimeout(()=>{document.body.style.transition=""},500)}
